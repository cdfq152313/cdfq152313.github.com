	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.19" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Android JNI 環境建置 &middot; Denny&#39;s Blog</title>
  

  
  <link rel="stylesheet" href="https://cdfq152313.github.io/css/poole.css">
  <link rel="stylesheet" href="https://cdfq152313.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://cdfq152313.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Denny&#39;s Blog" />
</head>

	<body class="theme-base-0f ">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://cdfq152313.github.io/"><h1>Denny&#39;s Blog</h1></a>
      <p class="lead">
       獸控天地 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/categories/notes"> 程式筆記 </a></li>
      
        <li><a href="/categories/misc"> 心得雜感 </a></li>
      
        <li><a href="/tags/"> 標籤列表 </a></li>
      
        <li><a href="/about/"> 關於我 </a></li>
      
    </ul>

    <p>&copy; 2017. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>Android JNI 環境建置</h1>
			  <span class="post-date">Fri, Aug 5, 2016</span>
			      

<h1 id="介紹">介紹</h1>

<p>主要參考這篇：
<a href="http://blog.xuite.net/lwchafter30/blog/373974237-Android+studio+1.5.1+NDK+JNI%E7%92%B0%E5%A2%83%E5%AE%89%E8A3%9D%E8%88%87%E5%9F%B7%E8%A1%8C%E5%8E%9F%E7%90%86" title="Android studio 1.5.1 NDK JNI環境安裝與執行原理">Android studio 1.5.1 NDK JNI環境安裝與執行原理</a>
不過Android 2.1.2上步驟稍有簡化，還是可以達到同樣效果。
1. 載NDK
2. 設定external tool (僅javah)
3. 在java中增加native code，並利用javah產生JNI header
4. 實作JNI
5. 設定gradle (僅ndk區塊)</p>

<h1 id="載ndk">載NDK</h1>

<p>開啟SDK Manager，選擇SDK Tools，將NDK之選項給打勾。
<img src="http://i.imgur.com/nsDiPAi.png" alt="SDK Manager" /></p>

<h1 id="設定external-tool">設定external tool</h1>

<p>與連結相同，不過只要設定javah即可，其他不需要。</p>

<p><img src="http://i.imgur.com/m4s02Gt.png" alt="javah設定" /></p>

<p>快速複製區 <a href="http://blog.xuite.net/lwchafter30/blog/373974237-Android+studio+1.5.1+NDK+JNI%E7%92%B0%E5%A2%83%E5%AE%89%E8A3%9D%E8%88%87%E5%9F%B7%E8%A1%8C%E5%8E%9F%E7%90%86" title="Android studio 1.5.1 NDK JNI環境安裝與執行原理">來源</a></p>

<pre><code>$JDKPath$/bin/javah

-v -jni -d $ModuleFileDir$/src/main/jni $FileClass$

$SourcepathEntry$
</code></pre>

<p>Windows和Linux在第1行稍有分別，只有在Windows系統中，執行檔的副檔名才是.exe。Mac和Linux皆否。
個人是用linux系統，所以第1行javah後面並不接.exe，若是Windows系統則第1行變為。</p>

<pre><code>$JDKPath$/bin/javah.exe
</code></pre>

<h1 id="jni-header">JNI header</h1>

<p>在想要使用JNI的class加入如下的程式碼。</p>

<pre><code>    static {
            System.loadLibrary(&quot;myJNI&quot;);
    }
    public native String getMycstring();
    public native void testLog();
</code></pre>

<p>static區塊中的myJNI會變成將來再build gradle當中的moduleName
method加上native關鍵詞後，程式就會知道這是需要依靠JNI實作之程式碼。</p>

<p>再來在該java檔上按右鍵，使用剛剛建置好的external library javah，自動的產生JNI header。
<img src="http://i.imgur.com/ag5rJ6c.png" alt="使用javah" /></p>

<p>此時在java目錄下，應該會多出一個jni的資料夾，裡頭放置著 OOXX.h
打開.h檔，建置出來的code應該會如下形式</p>

<pre><code class="language-c++">/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;jni.h&gt;
/* Header for class com_example_isa_myapplication_MainActivity */

#ifndef _Included_com_example_isa_myapplication_MainActivity
#define _Included_com_example_isa_myapplication_MainActivity
#ifdef __cplusplus
extern &quot;C&quot; {
#endif
/*
 * Class:     com_example_isa_myapplication_MainActivity
 * Method:    getMycstring
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_isa_myapplication_MainActivity_getMycstring
  (JNIEnv *, jobject);

/*
 * Class:     com_example_isa_myapplication_MainActivity
 * Method:    testLog
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_com_example_isa_myapplication_MainActivity_testLog
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif

</code></pre>

<h1 id="實作jni">實作JNI</h1>

<p>步驟如下
1. 在jni資料夾中，新增一個myJNI.cpp
2. include剛剛自動產生的header
3. 實作剛剛只宣告未實作的程式碼
4. (細節注意)</p>

<h2 id="新增myjni-cpp">新增myJNI.cpp</h2>

<p>在jni資料夾中，新增一個myJNI.cpp</p>

<h2 id="include剛剛自動產生的header">include剛剛自動產生的header</h2>

<pre><code class="language-c++">#include &quot;com_example_isa_myapplication_MainActivity.h&quot;
</code></pre>

<h2 id="實作剛剛只宣告未實作的程式碼">實作剛剛只宣告未實作的程式碼</h2>

<p>由於Log功能要使用到android/log.h library，所以也要include進來。</p>

<pre><code class="language-c++">#include &quot;com_example_isa_myapplication_MainActivity.h&quot;
#include &lt;android/log.h&gt;

JNIEXPORT jstring JNICALL Java_com_example_isa_myapplication_MainActivity_getMycstring
  (JNIEnv *env, jobject jobj){
        return (*env).NewStringUTF(&quot;MY !!  NDKString!!&quot;);
  }
  
JNIEXPORT void JNICALL Java_com_example_isa_myapplication_MainActivity_testLog
  (JNIEnv * env, jobject jobj){
    __android_log_print(ANDROID_LOG_INFO, &quot;JNI&quot;, &quot;JNI Test&quot;);
  }
</code></pre>

<h2 id="細節注意">細節注意</h2>

<p>當然僅僅如此還不夠，觀看.h檔可以發現有extern &ldquo;C&rdquo;包圍著宣告的函式，所以也要一併複製。</p>

<pre><code class="language-c++">#include &quot;com_example_isa_myapplication_MainActivity.h&quot;
#include &lt;android/log.h&gt;


#ifdef __cplusplus
extern &quot;C&quot; {
#endif

JNIEXPORT jstring JNICALL Java_com_example_isa_myapplication_MainActivity_getMycstring
  (JNIEnv *env, jobject jobj){
        return (*env).NewStringUTF(&quot;MY !!  NDKString!!&quot;);
  }
  
  JNIEXPORT void JNICALL Java_com_example_isa_myapplication_MainActivity_testLog
  (JNIEnv * env, jobject jobj){
    __android_log_print(ANDROID_LOG_INFO, &quot;JNI&quot;, &quot;JNI Test&quot;);
  }
  
#ifdef __cplusplus
}
#endif
</code></pre>

<p>切記不要連 #ifndef _Included_com_example_isa_myapplication_MainActivity 的相關句子也複製進來。
在.h檔已經定義過，若在.cpp重複定義，則中間的所有內容都會被忽略掉。</p>

<h1 id="設定gradle">設定gradle</h1>

<p>在defaultConfig這個區塊內加入</p>

<pre><code>ndk{
  moduleName &quot;myJNI&quot;
  ldLibs &quot;log&quot;
}
</code></pre>

<p>moduleName為你剛剛在System.loadLibrary裡面設定的名字。
ldLibs &ldquo;log&rdquo;可以讓cpp檔include log功能的時候不會出錯。</p>

<p>整體看起來是這樣</p>

<pre><code>android {
    compileSdkVersion 23
    buildToolsVersion &quot;23.0.2&quot;

    defaultConfig {
        applicationId &quot;com.example.isa.myapplication&quot;
        minSdkVersion 15
        targetSdkVersion 23
        versionCode 1
        versionName &quot;1.0&quot;
        ndk{
            moduleName &quot;myJNI&quot;
            ldLibs &quot;log&quot;
        }
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
</code></pre>

<p>最後編譯就完成了。</p>

<h1 id="參考資料">參考資料</h1>

<p><a href="http://blog.xuite.net/lwchafter30/blog/373974237-Android+studio+1.5.1+NDK+JNI%E7%92%B0%E5%A2%83%E5%AE%89%E8A3%9D%E8%88%87%E5%9F%B7%E8%A1%8C%E5%8E%9F%E7%90%86" title="Android studio 1.5.1 NDK JNI環境安裝與執行原理">Android studio 1.5.1 NDK JNI環境安裝與執行原理</a></p>

			</div>

			
		</div>

  </body>
</html>
