	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.19" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Python AES (PyCrypto) &middot; Denny&#39;s Blog</title>
  

  
  <link rel="stylesheet" href="https://cdfq152313.github.io/css/poole.css">
  <link rel="stylesheet" href="https://cdfq152313.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://cdfq152313.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Denny&#39;s Blog" />
</head>

	<body class="theme-base-0f ">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://cdfq152313.github.io/"><h1>Denny&#39;s Blog</h1></a>
      <p class="lead">
       獸控天地 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/categories/notes"> 程式筆記 </a></li>
      
        <li><a href="/categories/misc"> 心得雜感 </a></li>
      
        <li><a href="/tags/"> 標籤列表 </a></li>
      
        <li><a href="/about/"> 關於我 </a></li>
      
    </ul>

    <p>&copy; 2017. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>Python AES (PyCrypto)</h1>
			  <span class="post-date">Thu, Feb 23, 2017</span>
			      

<h1 id="程式碼">程式碼</h1>

<p>為了易於保存，所有金鑰、向量、輸出結果都是以Base64編碼。</p>

<pre><code class="language-python">from Crypto.Cipher import AES
from Crypto import Random
import base64

BS = AES.block_size
pad = lambda s: s + (BS - len(s) % BS) * chr(BS - len(s) % BS)
unpad = lambda s : s[0:-ord(s[-1])]

class AES_HELPER(object):
    def __init__(self):
        print 'init'

    def key_generator(self, bits=256):
        random = Random.new()
        key = random.read( bits/8 )
        return base64.b64encode(key)

    def iv_generator(self):
        '''
        AES Initialization Vector is 128 bits(16 bytes).
        '''
        random = Random.new()
        key = random.read( 16 )
        return base64.b64encode(key)

    def encrypt(self, b64key, b64iv, data):
        key = base64.b64decode(b64key)
        iv = base64.b64decode(b64iv)

        cryptor = AES.new(key, AES.MODE_CBC, iv)
        data = pad(data)
        encrypted = cryptor.encrypt(data)
        encrypted = base64.b64encode(encrypted)
        return encrypted

    def decrypt(self, b64key, b64iv, data):
        key = base64.b64decode(b64key)
        iv = base64.b64decode(b64iv)

        cryptor = AES.new(key, AES.MODE_CBC, iv)
        decrypted = base64.b64decode(data)
        decrypted = cryptor.decrypt(decrypted)
        decrypted = unpad( decrypted )
        return decrypted

aes_helper = AES_HELPER()
</code></pre>

<p>使用上也蠻容易的</p>

<pre><code class="language-python">if __name__ == '__main__':
    key = aes_helper.key_generator()
    iv = aes_helper.iv_generator()
    data = &quot;Hello moto. I'm fire. Thank you. I got fired. Thank you. Madadabi meow meow Madadabi meow.&quot;
    encrypted = aes_helper.encrypt(key, iv, data)
    decrypted = aes_helper.decrypt(key, iv, encrypted)
    print ('data: %s' % data )
    print ('encrypted: %s' % encrypted )
    print ('decrypted: %s' % decrypted )
</code></pre>

<h1 id="random的使用">Random的使用</h1>

<p>在使用AES的時候會需要用到兩個隨機生產的東西
1. 金鑰: 可為128 192 256 bits，金鑰長度越長越不容易被破解。
2. 初始化向量: 只有128 bits的形式，為了避免同樣的文章在同一金鑰下會被加密為同樣密文，從而增加被破解風險。</p>

<p>這邊要特別注意的是必須使用pycrypto所提供的Random，而不能用python原生地random，不然亂數會不夠安全。
以下為產生金鑰的程式碼</p>

<pre><code class="language-python">from Crypto import Random
import base64

def key_generator(bits=256):
  random = Random.new()
  key = random.read( bits/8 )
  return base64.b64encode(key)
</code></pre>

<p>使用random.read()來產生隨機的金鑰串，裡面的參數決定了金鑰串的長度，<strong>單位是bytes</strong>。
初始向量也是同樣的作法，只是這次要限制在128 bits(16 bytes)</p>

<h1 id="padding-pkcs5-pkcs7">Padding (PKCS5 / PKCS7)</h1>

<p>這邊要特別注意有所謂的padding問題，在網路上找了一些解決的方法，以下是程式碼。
<a href="http://likang.me/blog/2013/06/05/python-pycrypto-aes-ecb-pkcs-5/">http://likang.me/blog/2013/06/05/python-pycrypto-aes-ecb-pkcs-5/</a>
<a href="https://gist.github.com/crmccreary/5610068">https://gist.github.com/crmccreary/5610068</a></p>

<pre><code class="language-python">BS = 16
pad = lambda s: s + (BS - len(s) % BS) * chr(BS - len(s) % BS) 
unpad = lambda s : s[0:-ord(s[-1])]
</code></pre>

			</div>

			
		</div>

  </body>
</html>
